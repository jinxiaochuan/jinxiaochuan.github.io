{"title":"NodeJS Stream","uid":"495c7f3561d14b86e5bb70506dad2bf9","slug":"nodejs-stream","date":"2022-03-19T10:44:57.000Z","updated":"2022-03-19T07:29:57.934Z","comments":true,"path":"api/articles/nodejs-stream.json","keywords":null,"cover":[],"content":"<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p><em>Streams are Node’s best and most misunderstood idea.</em> <em>– Dominic Tarr</em></p></blockquote>\n<h4 id=\"Stream-是什么？\"><a href=\"#Stream-是什么？\" class=\"headerlink\" title=\"Stream 是什么？\"></a><em>Stream</em> 是什么？</h4><blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p><em>Streams are collections of data – just like arrays or strings. The difference is that streams might not be available all at once and they don’t have to fit in memory. This makes streams really powerful when working with large amounts of data, or data that’s coming from an external source one chunk at a time.</em><br>流是数据的集合，就像数组或字符串一样。不同之处在于，流可能不会一次全部可用，而且它们不必放入内存中。这使得流在处理大量数据或来自外部源的数据时非常强大，每次处理一个数据块。</p></blockquote>\n<p>Many of the built-in modules in Node implement the streaming interface:</p>\n<table>\n<thead>\n<tr>\n<th align=\"center\"><em>Readable Streams</em></th>\n<th align=\"left\"><em>Writable Streams</em></th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">HTTP response, on the client</td>\n<td align=\"left\">HTTP requests, on the client</td>\n</tr>\n<tr>\n<td align=\"center\">HTTP requests, on the server</td>\n<td align=\"left\">HTTP responses, on the server</td>\n</tr>\n<tr>\n<td align=\"center\">fs read streams</td>\n<td align=\"left\">fs write streams</td>\n</tr>\n<tr>\n<td align=\"center\">zlib streams</td>\n<td align=\"left\">zlib streams</td>\n</tr>\n<tr>\n<td align=\"center\">crypto streams</td>\n<td align=\"left\">crypto streams</td>\n</tr>\n<tr>\n<td align=\"center\">TCP sockets</td>\n<td align=\"left\">TCP sockets</td>\n</tr>\n<tr>\n<td align=\"center\">child process stdout &amp; stderr</td>\n<td align=\"left\">child process stdout</td>\n</tr>\n<tr>\n<td align=\"center\">process.stdin</td>\n<td align=\"left\">process.stdout, process.stderr</td>\n</tr>\n</tbody></table>\n<p>注意 ⚠️：</p>\n<ol>\n<li><em>HTTP response</em> 在客户端虽然是可读流，但是在服务端是可写流。这是因为在 HTTP 情况下，我们基本上是从一个对象(<em>HTTP.IncomingMessage</em>)读取数据，然后写入另一个对象(<em>HTTP.ServerResponse</em>) 。</li>\n<li>有些既是可读流又是可写流，比如 <em>TCP sockets</em> 、 <em>zlib streams</em> 、 <em>crypto streams</em> 。</li>\n</ol>\n<h4 id=\"从大文件请求窥探-Stream-优势\"><a href=\"#从大文件请求窥探-Stream-优势\" class=\"headerlink\" title=\"从大文件请求窥探 Stream 优势\"></a>从大文件请求窥探 <em>Stream</em> 优势</h4><blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p><em>创建一个大约 400 MB 的大文件</em></p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">const fs <span class=\"token operator\">=</span> require<span class=\"token punctuation\">(</span><span class=\"token string\">\"fs\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nconst <span class=\"token function\">file</span> <span class=\"token operator\">=</span> fs.createWriteStream<span class=\"token punctuation\">(</span><span class=\"token string\">\"./big.file\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>let i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;=</span> 1e6<span class=\"token punctuation\">;</span> i++<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n file.write<span class=\"token punctuation\">(</span>\n   <span class=\"token string\">\"Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.<span class=\"token entity\" title=\"\\n\">\\n</span>\"</span>\n <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span>\n\nfile.end<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><em>起个简单的服务以访问大文件</em></p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">const fs <span class=\"token operator\">=</span> require<span class=\"token punctuation\">(</span><span class=\"token string\">\"fs\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nconst server <span class=\"token operator\">=</span> require<span class=\"token punctuation\">(</span><span class=\"token string\">\"http\"</span><span class=\"token punctuation\">)</span>.createServer<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nserver.on<span class=\"token punctuation\">(</span><span class=\"token string\">\"request\"</span>, <span class=\"token punctuation\">(</span>req, res<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span>\n fs.readFile<span class=\"token punctuation\">(</span><span class=\"token string\">\"./big.file\"</span>, <span class=\"token punctuation\">(</span>err, data<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span>\n   <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> throw err<span class=\"token punctuation\">;</span>\n\n   res.end<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n <span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nserver.listen<span class=\"token punctuation\">(</span><span class=\"token number\">8000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><em>对比电脑前后内存消耗</em></p>\n<p><img src=\"https://jscomplete.com/images/reads/node-bb/picturenode5.png\"> &gt;<img src=\"https://jscomplete.com/images/reads/node-bb/picturenode5.png\"></p>\n<p>内存消耗直接由 <em>8.7 MB</em> 飙升至 <em>434.8 MB</em> 。<br>在我们将内容写入响应对象之前，将文件存储在内存中，这是非常低效且消耗服务器内存的，尤其在大文件场景下尤为明显（<em>Node</em> 是基于 <em>V8</em> 构建的， 而 <em>V8</em> 对于内存的使用有一定的限制。 在默认情况下， <em>64 位</em> 的机器大概可以使用 <em>1.4G</em> ， 而 <em>32 位</em> 则为 <em>0.7G</em> 的大小）。</p>\n<p><em>引入主角 Stream</em></p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">const fs <span class=\"token operator\">=</span> require<span class=\"token punctuation\">(</span><span class=\"token string\">\"fs\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nconst server <span class=\"token operator\">=</span> require<span class=\"token punctuation\">(</span><span class=\"token string\">\"http\"</span><span class=\"token punctuation\">)</span>.createServer<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nserver.on<span class=\"token punctuation\">(</span><span class=\"token string\">\"request\"</span>, <span class=\"token punctuation\">(</span>req, res<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span>\n const src <span class=\"token operator\">=</span> fs.createReadStream<span class=\"token punctuation\">(</span><span class=\"token string\">\"./big.file\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n src.pipe<span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nserver.listen<span class=\"token punctuation\">(</span><span class=\"token number\">8000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<p><img src=\"https://jscomplete.com/images/reads/node-bb/picturenode7.png\"></p>\n<p>内存使用量增加了大约 <em>25MB</em> ，仅此而已</p>\n<p>对于大文件的操作通常会使用 <em>Buffer</em> ， 究其原因就是因为 <em>Node</em> 中内存小的原因， 而使用 <em>Buffer</em> 是不受这个限制， 它是堆外内存(可通过 <code>process.memoryUsage()</code> 查看内存分配)</p></blockquote>\n<h4 id=\"Stream\"><a href=\"#Stream\" class=\"headerlink\" title=\"Stream\"></a>Stream</h4><h5 id=\"Stream-Type\"><a href=\"#Stream-Type\" class=\"headerlink\" title=\"Stream Type\"></a>Stream Type</h5><p>There are four fundamental stream types in Node: <em>Readable</em> , <em>Writable</em> , <em>Duplex</em> , and <em>Transform</em> streams .</p>\n<ul>\n<li><em>Readable</em> - A readable stream is an abstraction for a source from which data can be consumed. An example of that is the <code>fs.createReadStream</code> method.</li>\n<li><em>Writable</em> - A writable stream is an abstraction for a destination to which data can be written. An example of that is the <code>fs.createWriteStream</code> method.</li>\n<li><em>Duplex</em> - A duplex stream is both Readable and Writable. An example of that is a <code>TCP socket</code>.</li>\n<li><em>Transform</em> - A transform stream is basically a duplex stream that can be used to modify or transform the data as it is written and read. An example of that is the <code>zlib.createGzip</code> stream to compress the data using gzip. You can think of a transform stream as a function where the input is the writable stream part and the output is readable stream part. You might also hear transform streams referred to as “<code>through streams</code>”</li>\n</ul>\n<p>All streams are instances of <code>EventEmitter</code>. They emit events that can be used to read and write data. However, we can consume streams data in a simpler way using the pipe method.</p>\n<h5 id=\"Stream-Pipe-Method\"><a href=\"#Stream-Pipe-Method\" class=\"headerlink\" title=\"Stream Pipe Method\"></a>Stream Pipe Method</h5><blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p><em>The pipe method is the easiest way to consume streams.</em><br>管道方法是使用流的最简单方法。</p>\n<p><code>切记：通常建议使用管道方法或使用带有事件的流，但避免将这两种方法混合使用。</code> &gt; <code>即：当您使用管道方法时，您不需要使用事件，但是如果您需要以更自定义的方式使用流，那么事件就是最好的选择。</code></p></blockquote>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># In this simple line, we’re piping the output of a readable stream – the source of data, as the input of a writable stream – the destination.</span>\n<span class=\"token comment\"># The source has to be a readable stream and the destination has to be a writable one.</span>\nreadableSrc.pipe<span class=\"token punctuation\">(</span>writableDest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># they can both be duplex/transform streams as well. For streams readableSrc (readable), transformStream1 and transformStream2 (duplex/transform), and finalWritableDest (writable).</span>\nreadableSrc\n  .pipe<span class=\"token punctuation\">(</span>transformStream1<span class=\"token punctuation\">)</span>\n  .pipe<span class=\"token punctuation\">(</span>transformStream2<span class=\"token punctuation\">)</span>\n  .pipe<span class=\"token punctuation\">(</span>finalWritableDest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h5 id=\"Stream-Events\"><a href=\"#Stream-Events\" class=\"headerlink\" title=\"Stream Events\"></a>Stream Events</h5><p><code>Pipe</code> 除了从可读流中读取数据并写入可写流中之外，内部自动处理了很多事件。比如 <code>errors</code>, <code>end-of-files</code>, and <code>the cases when one stream is slower or faster than the other</code>.</p>\n<p>以下两种方式是等效的</p>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># pipe</span>\nreadable.pipe<span class=\"token punctuation\">(</span>writable<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># event listener</span>\nreadable.on<span class=\"token punctuation\">(</span><span class=\"token string\">\"data\"</span>, chunk <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span>\n  writable.write<span class=\"token punctuation\">(</span>chunk<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nreadable.on<span class=\"token punctuation\">(</span><span class=\"token string\">\"end\"</span>, <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token punctuation\">&#123;</span>\n  writable.end<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<table>\n<thead>\n<tr>\n<th align=\"center\"></th>\n<th align=\"left\"><em>Readable Streams</em></th>\n<th align=\"left\"><em>Writable Streams</em></th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">Events</td>\n<td align=\"left\">data, end, error, close, readable</td>\n<td align=\"left\">drain, finish, error, close, pipe, unpipe</td>\n</tr>\n<tr>\n<td align=\"center\">Methods</td>\n<td align=\"left\">pipe(), unpipe(), wrap(), destroy()</td>\n<td align=\"left\">write(), destroy(), end()</td>\n</tr>\n<tr>\n<td align=\"center\"></td>\n<td align=\"left\">read(), unshift(), resume(), pause(), isPaused(), setEncoding()</td>\n<td align=\"left\">cork(), uncork(), setDefaultEncoding()</td>\n</tr>\n</tbody></table>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>The most important events on a <code>readable stream</code> are:</p>\n<ul>\n<li><p>The <code>data</code> event, which is emitted whenever the stream passes a chunk of data to the consumer</p>\n</li>\n<li><p>The <code>end</code> event, which is emitted when there is no more data to be consumed from the stream.</p>\n</li>\n</ul>\n<p>The most important events on a <code>writable stream</code> are:</p>\n<ul>\n<li><p>The <code>drain</code> event, which is a signal that the writable stream can receive more data.</p>\n</li>\n<li><p>The <code>finish</code> event, which is emitted when all data has been flushed to the underlying system.</p>\n</li>\n</ul></blockquote>\n<h4 id=\"Paused-and-Flowing-Modes\"><a href=\"#Paused-and-Flowing-Modes\" class=\"headerlink\" title=\"Paused and Flowing Modes\"></a>Paused and Flowing Modes</h4><blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>Readable streams have two main modes that affect the way we can consume them:</p>\n<ul>\n<li>They can be either in the <code>paused</code> mode</li>\n<li>Or in the <code>flowing</code> mode</li>\n</ul>\n<p>Those modes are sometimes referred to as <code>pull</code> and <code>push</code> modes.<br>这两种模式有时被称为 <code>拉模式</code> 和 <code>推模式</code> 。</p></blockquote>\n<p>默认情况下，所有可读流都以 <code>paused mode</code> 启动，但在需要时，它们可以轻松切换为 <code>flowing mode</code>，同时在必要时也可切换回 <code>paused mode</code>。</p>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p><em>When a readable stream is in the paused mode, we can use the read() method to read from the stream on demand. However, for a readable stream in the flowing mode, the data is continuously flowing and we have to listen to events to consume it.</em><br>当可读流处于暂停模式时，我们可以使用 <code>read()</code> 方法按需读取流。然而，对于流动模式下的可读流，数据是连续流动的，我们必须监听事件才能使用它。</p>\n<p><em>In the flowing mode, data can actually be lost if no consumers are available to handle it. This is why when we have a readable stream in flowing mode, we need a data event handler. In fact, just adding a data event handler switches a paused stream into flowing mode and removing the data event handler switches the stream back to paused mode. Some of this is done for backward compatibility with the older Node streams interface.</em><br>在流动模式下，如果没有消费者来处理数据，数据实际上可能会丢失。这就是为什么当我们有一个流动模式的可读流时，我们需要一个数据事件处理程序。事实上，只需添加数据事件处理程序，即可将暂停的流切换到流动模式，删除数据事件处理程序，即可将流切换回暂停模式。其中一些是为了向后兼容旧的节点流接口。</p></blockquote>\n<blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p><em>To manually switch between these two stream modes, you can use the resume() and pause() methods.</em><br>要在这两种流模式之间手动切换，可以使用 <code>resume()</code> 和 <code>pause()</code> 方法</p>\n<p><em>When consuming readable streams using the pipe method, we don’t have to worry about these modes as pipe manages them automatically.</em><br>当使用 <code>pipe</code> 方法消费可读流时，我们不必担心这些模式，因为 <code>pipe</code> 会自动管理它们。</p></blockquote>\n<h4 id=\"Implementing-Streams\"><a href=\"#Implementing-Streams\" class=\"headerlink\" title=\"Implementing Streams\"></a>Implementing Streams</h4><h5 id=\"Implementing-a-Writable-Stream\"><a href=\"#Implementing-a-Writable-Stream\" class=\"headerlink\" title=\"Implementing a Writable Stream\"></a>Implementing a Writable Stream</h5><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">const <span class=\"token punctuation\">&#123;</span> Writable <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> require<span class=\"token punctuation\">(</span><span class=\"token string\">\"stream\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nconst outStream <span class=\"token operator\">=</span> new Writable<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n  <span class=\"token comment\"># This write method takes three arguments.</span>\n  <span class=\"token comment\"># The chunk is usually a buffer unless we configure the stream differently.</span>\n  <span class=\"token comment\"># The encoding argument is needed in that case, but we can usually ignore it.</span>\n  <span class=\"token comment\"># The callback is a function that we need to call after we’re done processing the data chunk. It’s what signals whether the write was successful or not. To signal a failure, call the callback with an error object.</span>\n  write<span class=\"token punctuation\">(</span>chunk, encoding, callback<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    console.log<span class=\"token punctuation\">(</span>chunk.toString<span class=\"token punctuation\">(</span><span class=\"token punctuation\">))</span><span class=\"token punctuation\">;</span>\n    callback<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nprocess.stdin.pipe<span class=\"token punctuation\">(</span>outStream<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h5 id=\"Implement-a-Readable-Stream\"><a href=\"#Implement-a-Readable-Stream\" class=\"headerlink\" title=\"Implement a Readable Stream\"></a>Implement a Readable Stream</h5><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">const <span class=\"token punctuation\">&#123;</span> Readable <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> require<span class=\"token punctuation\">(</span><span class=\"token string\">\"stream\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nconst inStream <span class=\"token operator\">=</span> new Readable<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\ninStream.push<span class=\"token punctuation\">(</span><span class=\"token string\">\"ABCDEFGHIJKLM\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\ninStream.push<span class=\"token punctuation\">(</span><span class=\"token string\">\"NOPQRSTUVWXYZ\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\ninStream.push<span class=\"token punctuation\">(</span>null<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> // No <span class=\"token function\">more</span> data\n\ninStream.pipe<span class=\"token punctuation\">(</span>process.stdout<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">const inStream <span class=\"token operator\">=</span> new Readable<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n  read<span class=\"token punctuation\">(</span>size<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    this.push<span class=\"token punctuation\">(</span>String.fromCharCode<span class=\"token punctuation\">(</span>this.currentCharCode++<span class=\"token punctuation\">))</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>this.currentCharCode <span class=\"token operator\">></span> <span class=\"token number\">90</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      this.push<span class=\"token punctuation\">(</span>null<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\ninStream.currentCharCode <span class=\"token operator\">=</span> <span class=\"token number\">65</span><span class=\"token punctuation\">;</span>\n\ninStream.pipe<span class=\"token punctuation\">(</span>process.stdout<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h5 id=\"Implementing-Duplex-Streams\"><a href=\"#Implementing-Duplex-Streams\" class=\"headerlink\" title=\"Implementing Duplex Streams\"></a>Implementing Duplex Streams</h5><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">const <span class=\"token punctuation\">&#123;</span> Duplex <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> require<span class=\"token punctuation\">(</span><span class=\"token string\">\"stream\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nconst inoutStream <span class=\"token operator\">=</span> new Duplex<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n  write<span class=\"token punctuation\">(</span>chunk, encoding, callback<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    console.log<span class=\"token punctuation\">(</span><span class=\"token variable\"><span class=\"token variable\">`</span>duplex stream write: $<span class=\"token punctuation\">&#123;</span>chunk<span class=\"token punctuation\">&#125;</span><span class=\"token variable\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    callback<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>,\n\n  read<span class=\"token punctuation\">(</span>size<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    this.push<span class=\"token punctuation\">(</span>String.fromCharCode<span class=\"token punctuation\">(</span>this.currentCharCode++<span class=\"token punctuation\">))</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>this.currentCharCode <span class=\"token operator\">></span> <span class=\"token number\">90</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      this.push<span class=\"token punctuation\">(</span>null<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\ninoutStream.currentCharCode <span class=\"token operator\">=</span> <span class=\"token number\">65</span><span class=\"token punctuation\">;</span>\n\nprocess.stdin.pipe<span class=\"token punctuation\">(</span>inoutStream<span class=\"token punctuation\">)</span>.pipe<span class=\"token punctuation\">(</span>process.stdout<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h5 id=\"Implementing-Transform-Streams\"><a href=\"#Implementing-Transform-Streams\" class=\"headerlink\" title=\"Implementing Transform Streams\"></a>Implementing Transform Streams</h5><pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\">const <span class=\"token punctuation\">&#123;</span> Transform <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> require<span class=\"token punctuation\">(</span><span class=\"token string\">\"stream\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nconst upperCaseTr <span class=\"token operator\">=</span> new Transform<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n  transform<span class=\"token punctuation\">(</span>chunk, encoding, callback<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    this.push<span class=\"token punctuation\">(</span>chunk.toString<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>.toUpperCase<span class=\"token punctuation\">(</span><span class=\"token punctuation\">))</span><span class=\"token punctuation\">;</span>\n    callback<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nprocess.stdin.pipe<span class=\"token punctuation\">(</span>upperCaseTr<span class=\"token punctuation\">)</span>.pipe<span class=\"token punctuation\">(</span>process.stdout<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h5 id=\"Streams-Object-Mode\"><a href=\"#Streams-Object-Mode\" class=\"headerlink\" title=\"Streams Object Mode\"></a>Streams Object Mode</h5><blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>By default, streams expect <code>Buffer/String</code> values. There is an <code>objectMode</code> flag that we can set to have the stream accept any <code>JavaScript object</code>.</p></blockquote>\n<pre class=\"line-numbers language-bash\" data-language=\"bash\"><code class=\"language-bash\"><span class=\"token comment\"># Here’s a simple example to demonstrate that. The following combination of transform streams makes a feature to map a string of comma-separated values into a JavaScript object. So \"a,b,c,d\" becomes &#123;a: b, c: d&#125;</span>\n\nconst <span class=\"token punctuation\">&#123;</span> Transform <span class=\"token punctuation\">&#125;</span> <span class=\"token operator\">=</span> require<span class=\"token punctuation\">(</span><span class=\"token string\">\"stream\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nconst commaSplitter <span class=\"token operator\">=</span> new Transform<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n  readableObjectMode: true,\n\n  transform<span class=\"token punctuation\">(</span>chunk, encoding, callback<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    this.push<span class=\"token punctuation\">(</span>\n      chunk\n        .toString<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        .trim<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        .split<span class=\"token punctuation\">(</span><span class=\"token string\">\",\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    callback<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nconst arrayToObject <span class=\"token operator\">=</span> new Transform<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n  readableObjectMode: true,\n  writableObjectMode: true,\n  transform<span class=\"token punctuation\">(</span>chunk, encoding, callback<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    const obj <span class=\"token operator\">=</span> <span class=\"token punctuation\">&#123;</span><span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>let i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> chunk.length<span class=\"token punctuation\">;</span> i <span class=\"token operator\">+=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n      obj<span class=\"token punctuation\">[</span>chunk<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> chunk<span class=\"token punctuation\">[</span>i + <span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">&#125;</span>\n    this.push<span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    callback<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nconst objectToString <span class=\"token operator\">=</span> new Transform<span class=\"token punctuation\">(</span><span class=\"token punctuation\">&#123;</span>\n  writableObjectMode: true,\n  transform<span class=\"token punctuation\">(</span>chunk, encoding, callback<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">&#123;</span>\n    this.push<span class=\"token punctuation\">(</span>JSON.stringify<span class=\"token punctuation\">(</span>chunk<span class=\"token punctuation\">)</span> + <span class=\"token string\">\"<span class=\"token entity\" title=\"\\n\">\\n</span>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    callback<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">&#125;</span>\n<span class=\"token punctuation\">&#125;</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nprocess.stdin\n  .pipe<span class=\"token punctuation\">(</span>commaSplitter<span class=\"token punctuation\">)</span>\n  .pipe<span class=\"token punctuation\">(</span>arrayToObject<span class=\"token punctuation\">)</span>\n  .pipe<span class=\"token punctuation\">(</span>objectToString<span class=\"token punctuation\">)</span>\n  .pipe<span class=\"token punctuation\">(</span>process.stdout<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span><span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h4 id=\"参考\"><a href=\"#参考\" class=\"headerlink\" title=\"参考\"></a>参考</h4><p><a href=\"https://jscomplete.com/learn/node-beyond-basics/node-streams\">Node’s Streams</a><br><a href=\"https://juejin.cn/post/6844903891083984910\">想学 Node.js，stream 先有必要搞清楚</a><br><a href=\"https://juejin.cn/post/6844904017546444808\">Node.js 内存溢出时如何处理？</a><br><a href=\"https://juejin.cn/post/6844903837912973326\">Node - 内存管理和垃圾回收</a><br><a href=\"https://juejin.cn/post/6844903582089609224\">Node.js Writable Stream 的实现简析</a></p>\n","feature":true,"text":" Streams are Node’s best and most misunderstood idea. – Dominic Tarr Stream 是什么？ Streams are collections of data – just like arrays or strin...","link":"","photos":[],"count_time":{"symbolsCount":"11k","symbolsTime":"10 mins."},"categories":[],"tags":[{"name":"NodeJS","slug":"NodeJS","count":1,"path":"api/tags/NodeJS.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#Stream-%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F\"><span class=\"toc-text\">Stream 是什么？</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E4%BB%8E%E5%A4%A7%E6%96%87%E4%BB%B6%E8%AF%B7%E6%B1%82%E7%AA%A5%E6%8E%A2-Stream-%E4%BC%98%E5%8A%BF\"><span class=\"toc-text\">从大文件请求窥探 Stream 优势</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#Stream\"><span class=\"toc-text\">Stream</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#Stream-Type\"><span class=\"toc-text\">Stream Type</span></a></li><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#Stream-Pipe-Method\"><span class=\"toc-text\">Stream Pipe Method</span></a></li><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#Stream-Events\"><span class=\"toc-text\">Stream Events</span></a></li></ol></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#Paused-and-Flowing-Modes\"><span class=\"toc-text\">Paused and Flowing Modes</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#Implementing-Streams\"><span class=\"toc-text\">Implementing Streams</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#Implementing-a-Writable-Stream\"><span class=\"toc-text\">Implementing a Writable Stream</span></a></li><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#Implement-a-Readable-Stream\"><span class=\"toc-text\">Implement a Readable Stream</span></a></li><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#Implementing-Duplex-Streams\"><span class=\"toc-text\">Implementing Duplex Streams</span></a></li><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#Implementing-Transform-Streams\"><span class=\"toc-text\">Implementing Transform Streams</span></a></li><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#Streams-Object-Mode\"><span class=\"toc-text\">Streams Object Mode</span></a></li></ol></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E5%8F%82%E8%80%83\"><span class=\"toc-text\">参考</span></a></li></ol>","author":{"name":"Matrix","slug":"blog-author","avatar":"https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/8/2/16c515569d19fc87~tplv-t2oaga2asx-no-mark:500:500:500:500.awebp","link":"/","description":"","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{},"next_post":{"title":"webpack 打包优化","uid":"e76dee0a8c7a5ee4319d8141408a59cb","slug":"webpack-bundle-optimization","date":"2022-02-23T10:57:14.000Z","updated":"2022-03-19T07:29:57.934Z","comments":true,"path":"api/articles/webpack-bundle-optimization.json","keywords":null,"cover":null,"text":"webpack 打包优化我们知道 webpack 打包优化很重要，不论是优化开发体验还是优化打包速度、体积都是很有益处的 缩小文件搜索范围优化 loader 配置include/exclude 将 node_modules 中的文件进行包括&#x2F;排除 &#123; rule...","link":"","photos":[],"count_time":{"symbolsCount":"12k","symbolsTime":"11 mins."},"categories":[],"tags":[{"name":"webpack","slug":"webpack","count":1,"path":"api/tags/webpack.json"}],"author":{"name":"Matrix","slug":"blog-author","avatar":"https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/8/2/16c515569d19fc87~tplv-t2oaga2asx-no-mark:500:500:500:500.awebp","link":"/","description":"","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"feature":true}}