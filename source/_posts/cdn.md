---
title: CDN
date: 2022-02-08 19:56:46
tags:
---

#### 什么是 CDN？

CDN 的全称是 Content Delivery Network，即内容分发网络。是指一种通过互联网互相连接的电脑网络系统，利用最靠近每位用户的服务器，更快、更可靠地将音乐、图片、视频、应用程序及其他文件发送给用户，来提供高性能、可扩展性及低成本的网络内容传递给用户。

现实中我们都用过天猫超市，在上面买东西非常方便。天猫超市的模式是货品先入天猫超市（后文简称为"猫超"）的菜鸟仓，然后由猫超统一派送的。

![cdn](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/8/5/16c5f7c722ca14fc~tplv-t2oaga2asx-watermark.awebp)

#### CDN 的基本工作过程

###### 一图秒懂 CDN 原理（以访问网站某网页资源请求为例）

![cdn](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fcd8f20339064af1a4e3e4847e0a3d6a~tplv-k3u1fbpfcp-watermark.awebp)

###### 引入 CDN 之前

- 用户在自己的浏览器中输入要访问的网站域名
- 浏览器向本地 DNS 服务器请求对该域名的解析
- 本地 DNS 服务器中如果缓存有这个域名的解析结果，则直接响应用户的解析请求
- 本地 DNS 服务器中如果没有关于这个域名的解析结果的缓存，则以迭代方式向整个 DNS 系统请求解析，获得应答后将结果反馈给浏览器
- 浏览器得到域名解析结果，就是该域名相应的服务设备的 IP 地址
- 浏览器获取 IP 地址之后，经过标准的 TCP 握手流程，建立 TCP 连接
- 浏览器向服务器发起 HTTP 请求
- 服务器将用户请求内容传送给浏览器
- 经过标准的 TCP 挥手流程，断开 TCP 连接

###### 引入 CDN 之后

- 当用户点击网站页面上的内容 URL，先经过本地 DNS 系统解析，如果本地 DNS 服务器没有相应域名的缓存，则本地 DNS 系统会将域名的解析权交给 _CNAME_ 指向的 CDN 专用 DNS 服务器
- CDN 的 DNS 服务器将 CDN 的全局负载均衡设备 IP 地址返回给用户
- 用户向 CDN 的全局负载均衡设备发起 URL 访问请求
- CDN 全局负载均衡设备根据用户 IP 地址，以及用户请求的 URL，选择一台用户所属区域的区域负载均衡设备，并将请求转发到此设备上
- 基于以下这些条件的综合分析之后，区域负载均衡设备会选择一个最优的缓存服务器节点，并从缓存服务器节点处得到缓存服务器的 IP 地址，最终将得到的 IP 地址返回给全局负载均衡设备
  - 根据用户 IP 地址，判断哪一个边缘节点距用户最近
  - 根据用户所请求的 URL 中携带的内容名称，判断哪一个边缘节点上有用户所需内容
  - 查询各个边缘节点当前的负载情况，判断哪一个边缘节点尚有服务能力
- 全局负载均衡设备把服务器的 IP 地址返回给用户
- 用户向缓存服务器发起请求，缓存服务器响应用户请求，将用户所需内容传送到用户终端。如果这台缓存服务器上并没有用户想要的内容，而区域均衡设备依然将它分配给了用户，那么这台服务器就要向它的上一级缓存服务器请求内容，直至追溯到网站的源服务器将内容拉到本地

#### CNAME 记录是什么？他存在的意义是什么？

记录就是把一个域名解析到一个 IP 地址（Address，特制数字 IP 地址），而 CNAME 记录就是把域名解析到另外一个域名。其功能是差不多，CNAME 将几个主机名指向一个别名，其实跟指向 IP 地址是一样的，因为这个别名也要做一个 A 记录的。但是使用 CNAME 记录可以很方便地变更 IP 地址。如果一台服务器有 100 个网站，他们都做了别名，该台服务器变更 IP 时，只需要变更别名的 A 记录就可以了。

如果服务商给你一个 ip，假如哪天服务商想把 ip 地址换一个，很多人域名上对应的 ip 地址就要跟着变化，要让所有人都一起改完，完全没有办法做到的事情，换成 cname 就没事了，你用你的 cdn，他改他的 ip 地址。唯一的坏处就是，第一次 DNS 解析域名的时候会多解析一次。总结来看，好处远大于坏处。

###### 什么是 CNAME 记录？

CName 记录是 Canonical Name 的简称，通常称别名指向，CNAME 记录可用于将一个域名别名为另一个规范名称的域名系统（DNS）资源记录。　　网站是由一组由一组唯一标识的位置（称为 IP 地址）提供服务的；但是要访问这些站点（例如：晓得博客），我们通常会键入它们对应的域名，这些域名更容易记住。要找到正确的 IP 地址，您的浏览器将联系域名服务器（DNS），并在其数据库中查询 IP 地址。

###### CNAME 记录如何使用？

例如，假设您有几个子域，例如http://www.mydomain.com，http://ftp.mydomain.com，http://mail.mydomain.com等，并且您希望这些子域指向您的主域名http://mydomain.com。您可以创建CNAME记录，而不是为每个子域创建A记录并将其绑定到您域的IP地址。
如下表所示，如果服务器的 IP 地址发生更改，则只需更新一个 A 记录，并且所有子域都会自动更新，因为所有 CNAMES 都指向带有 A 记录的主域：
![cname](https://pic1.zhimg.com/v2-aab77a543b11a4a3ecf40ec226f1af4e_r.jpg?source=1940ef5c)
http://mydomain.com指向服务器IP地址，并通过http://www.mydomain.com指向相同的地址http://mydomain.com。如果IP地址发生更改，则只需要在一个地方进行更新即可：只需为修改A记录http://mydomain.com，那么http://www.mydomain.com自动继承更改。
　　 CNAME 记录必须始终指向另一个域名，永远不要直接指向 IP 地址。如果您尝试将 CNAME 记录指向 IP 地址，DNSimple 的记录编辑器会警告您。CNAME 对其他记录必须是唯一的。CNAME 记录局限性
　　 CNAME 记录必须始终指向另一个域名，并且永远不要直接指向 IP 地址。
　　您不能为主域名（http://mydomain.com）本身创建CNAME记录，该记录必须是A记录。
　　例如，您不能将http://mydomain.com映射到http://google.com，但是可以将http://google.mydomain.com映射到http://google.com。
　　使用 CNAME 记录意味着有一个额外的请求发送到 DNS 服务器，这可能会导致几毫秒的延迟。
　　一个 CNAME 记录不能与另一个具有相同名称的记录共存。不能同时有 CNAME 和 TXT 记录http://www.example.com。
　　一个 CNAME 可以指向另一个 CNAME，尽管出于性能原因通常不建议使用此配置。如果适用，CNAME 应该尽可能地指向目标名称，以避免不必要的性能开销。

#### 如何解决 CDN 缓存

1. 资源 url 参数加时间戳
   url 的参数加上时间戳，每次更新时时间戳也跟随更新，重新使 cdn 边缘节点同步源服务器最新数据。
   调用 cdn 服务商提供的刷新缓存接口

```bash
http://www.cdn.com/static/images/test.png # 没加时间戳
http://www.cdn.com/static/images/test.png?_t=202012290910 # 加了时间戳
```

2. 调用 cdn 服务商提供的刷新缓存接口
   CDN 边缘节点对开发者是透明的，相比于浏览器 Ctrl+F5 的强制刷新来使浏览器本地缓存失效，开发者可以通过 CDN 服务商提供的“刷新缓存”接口来达到清理 CDN 边缘节点缓存的目的。
   这样开发者在更新数据后，可以使用“刷新缓存”功能来强制 CDN 节点上的数据缓存过期，保证客户端在访问时，拉取到最新的数据。

#### CDN 的应用场景

1. 网站站点/应用加速
   站点或者应用中大量静态资源的加速分发，建议将站点内容进行动静分离，动态文件可以结合云服务器 ECS，静态资源如各类型图片、html、css、js 文件等，建议结合 对象存储 OSS 存储海量静态资源，可以有效加速内容加载速度，轻松搞定网站图片、短视频等内容分发
2. 视音频点播/大文件下载分发加速
   支持各类文件的下载、分发，支持在线点播加速业务，如 mp4、flv 视频文件或者平均单个文件大小在 20M 以上，主要的业务场景是视音频点播、大文件下载（如安装包下载）等，建议搭配对象存储 OSS 使用，可提升回源速度，节约近 2/3 回源带宽成本。
3. 视频直播加速（内测中）
   视频流媒体直播服务，支持媒资存储、切片转码、访问鉴权、内容分发加速一体化解决方案。结合弹性伸缩服务，及时调整服务器带宽，应对突发访问流量；结合媒体转码服务，享受高速稳定的并行转码，且任务规模无缝扩展。目前 CDN 直播加速已服务内部用户测试并优化，即将上线
4. 移动应用加速
   移动 APP 更新文件（apk 文件）分发，移动 APP 内图片、页面、短视频、UGC 等内容的优化加速分发。提供 httpDNS 服务，避免 DNS 劫持并获得实时精确的 DNS 解析结果，有效缩短用户访问时间，提升用户体验。

#### 参考

[也许是史上最全的一次 CDN 详解](https://zhuanlan.zhihu.com/p/28940451)
[一图秒懂 CDN 原理](https://juejin.cn/post/6962904216503320589)
